<?php
/**
 * HeatAQ Authentication Module
 * Validates user sessions and provides auth context to APIs
 *
 * Usage:
 * $auth = HeatAQAuth::check(true);  // Required auth - redirects on failure
 * $auth = HeatAQAuth::check(false); // Optional auth - returns null if not logged in
 *
 * Returns:
 * [
 *     'user' => ['user_id' => int, 'name' => string, 'email' => string, 'role' => string],
 *     'project' => ['project_id' => int, 'project_name' => string, 'site_id' => string, 'pool_site_id' => int]
 * ]
 *
 * Note: site_id comes from pool_sites table (linked via project_id), not projects table
 */

require_once __DIR__ . '/config.php';

class HeatAQAuth {
    private static $db = null;
    private static $sessionConfig = null;

    /**
     * Check authentication status
     * @param bool $required If true, redirect to login if not authenticated
     * @return array|null Auth data or null if not authenticated
     */
    public static function check($required = true) {
        self::initDB();

        // Start PHP session if not already started
        if (session_status() === PHP_SESSION_NONE) {
            session_start();
        }

        $sessionName = self::$sessionConfig['name'] ?? 'heataq_session';

        // Get session ID from multiple sources
        $sessionId = null;

        // 1. Check PHP session
        if (isset($_SESSION[$sessionName . '_session_id'])) {
            $sessionId = $_SESSION[$sessionName . '_session_id'];
        }

        // 2. Check Authorization header
        if (!$sessionId) {
            $headers = getallheaders();
            $authHeader = $headers['Authorization'] ?? $headers['authorization'] ?? '';
            if (preg_match('/^Bearer\s+(.+)$/i', $authHeader, $matches)) {
                $sessionId = $matches[1];
            }
        }

        // 3. Check X-Session-ID header
        if (!$sessionId) {
            $headers = getallheaders();
            $sessionId = $headers['X-Session-ID'] ?? $headers['x-session-id'] ?? null;
        }

        // 4. Check cookie
        if (!$sessionId && isset($_COOKIE[$sessionName])) {
            $sessionId = $_COOKIE[$sessionName];
        }

        if (!$sessionId) {
            return self::handleNotAuthenticated($required);
        }

        // Validate session in database
        // Note: site_id now comes from pool_sites (via project_id), not from projects
        $stmt = self::$db->prepare("
            SELECT
                us.session_id,
                us.user_id,
                us.project_id,
                us.expires_at,
                u.name as user_name,
                u.email,
                u.is_super_admin,
                p.project_name,
                ps.site_id,
                ps.id as pool_site_id,
                COALESCE(up.role, 'viewer') as role
            FROM user_sessions us
            JOIN users u ON us.user_id = u.user_id
            JOIN projects p ON us.project_id = p.project_id
            LEFT JOIN pool_sites ps ON ps.project_id = p.project_id
            LEFT JOIN user_projects up ON up.user_id = us.user_id AND up.project_id = us.project_id
            WHERE us.session_id = ?
              AND us.expires_at > NOW()
              AND u.is_active = 1
              AND p.is_active = 1
        ");
        $stmt->execute([$sessionId]);
        $session = $stmt->fetch(PDO::FETCH_ASSOC);

        if (!$session) {
            // Session invalid or expired
            self::clearSession($sessionName);
            return self::handleNotAuthenticated($required);
        }

        // Super admins get owner role
        if ($session['is_super_admin']) {
            $session['role'] = 'owner';
        }

        // Update last activity
        $stmt = self::$db->prepare("
            UPDATE user_sessions
            SET last_activity = NOW()
            WHERE session_id = ?
        ");
        $stmt->execute([$sessionId]);

        // Return auth context
        return [
            'user' => [
                'user_id' => (int)$session['user_id'],
                'name' => $session['user_name'],
                'email' => $session['email'],
                'role' => $session['role'],
                'is_super_admin' => (bool)$session['is_super_admin']
            ],
            'project' => [
                'project_id' => (int)$session['project_id'],
                'project_name' => $session['project_name'],
                'site_id' => $session['site_id'],  // From pool_sites, may be null
                'pool_site_id' => $session['pool_site_id'] ? (int)$session['pool_site_id'] : null
            ],
            'session_id' => $sessionId
        ];
    }

    /**
     * Get current user ID without full auth check
     */
    public static function getUserId() {
        $auth = self::check(false);
        return $auth ? $auth['user']['user_id'] : null;
    }

    /**
     * Get current project ID without full auth check
     */
    public static function getProjectId() {
        $auth = self::check(false);
        return $auth ? $auth['project']['project_id'] : null;
    }

    /**
     * Logout current user
     */
    public static function logout() {
        self::initDB();

        if (session_status() === PHP_SESSION_NONE) {
            session_start();
        }

        $sessionName = self::$sessionConfig['name'] ?? 'heataq_session';
        $sessionId = $_SESSION[$sessionName . '_session_id'] ?? null;

        if ($sessionId) {
            // Delete from database
            $stmt = self::$db->prepare("DELETE FROM user_sessions WHERE session_id = ?");
            $stmt->execute([$sessionId]);
        }

        // Clear PHP session
        self::clearSession($sessionName);
    }

    /**
     * Initialize database connection
     */
    private static function initDB() {
        if (!self::$db) {
            self::$db = Config::getDatabase();
            self::$sessionConfig = Config::getSessionConfig();
        }
    }

    /**
     * Handle not authenticated case
     */
    private static function handleNotAuthenticated($required) {
        if ($required) {
            // For API requests, return 401
            if (self::isApiRequest()) {
                http_response_code(401);
                header('Content-Type: application/json');
                echo json_encode(['error' => 'Authentication required', 'redirect' => '/login.html']);
                exit;
            }

            // For page requests, redirect to login
            header('Location: /login.html');
            exit;
        }

        return null;
    }

    /**
     * Check if this is an API request
     */
    private static function isApiRequest() {
        $uri = $_SERVER['REQUEST_URI'] ?? '';
        $accept = $_SERVER['HTTP_ACCEPT'] ?? '';

        return strpos($uri, '/api/') !== false
            || strpos($accept, 'application/json') !== false
            || isset($_SERVER['HTTP_X_REQUESTED_WITH']);
    }

    /**
     * Clear session data
     */
    private static function clearSession($sessionName) {
        unset($_SESSION[$sessionName . '_session_id']);
        unset($_SESSION[$sessionName . '_user_id']);
        unset($_SESSION[$sessionName . '_project_id']);
        unset($_SESSION[$sessionName . '_site_id']);

        // Clear cookie if set
        if (isset($_COOKIE[$sessionName])) {
            setcookie($sessionName, '', time() - 3600, '/');
        }
    }
}
