<?php
/**
 * HeatAQ Session Authentication
 * Version: 2.3 - Uses pool_site_id (INT) instead of VARCHAR site_id
 * Include this file in any PHP that requires authentication
 *
 * Note: pool_site_id is the INT primary key from pool_sites table (linked via project_id)
 * The VARCHAR site_id column was removed in migration 027.
 */

// Include configuration loader
require_once __DIR__ . '/config.php';

class HeatAQAuth {
    private static $pdo = null;
    private static $user = null;
    private static $project = null;
    private static $session = null;

    /**
     * Initialize database connection
     */
    private static function initDB() {
        if (self::$pdo === null) {
            try {
                self::$pdo = Config::getDatabase();
            } catch (Exception $e) {
                throw new Exception('Database connection failed');
            }
        }
        return self::$pdo;
    }

    /**
     * Check if user is authenticated
     * @param bool $requireAuth If true, will exit with 401 if not authenticated
     * @return array|false User and project data if authenticated
     */
    public static function check($requireAuth = true) {
        session_start();

        $sessionConfig = Config::getSessionConfig();
        $sessionName = $sessionConfig['name'];

        // Check for session ID in multiple places
        $sessionId = null;

        // 1. Check PHP session
        if (isset($_SESSION[$sessionName . '_session_id'])) {
            $sessionId = $_SESSION[$sessionName . '_session_id'];
        }
        // 2. Check Authorization header
        elseif (isset($_SERVER['HTTP_AUTHORIZATION'])) {
            $sessionId = str_replace('Bearer ', '', $_SERVER['HTTP_AUTHORIZATION']);
        }
        // 3. Check X-Session-ID header
        elseif (isset($_SERVER['HTTP_X_SESSION_ID'])) {
            $sessionId = $_SERVER['HTTP_X_SESSION_ID'];
        }
        // 4. Check POST/GET parameter
        elseif (isset($_REQUEST['session_id'])) {
            $sessionId = $_REQUEST['session_id'];
        }

        if (!$sessionId) {
            if ($requireAuth) {
                self::unauthorized('No session provided');
            }
            return false;
        }

        // Verify session in database
        $pdo = self::initDB();

        // Join with pool_sites to get pool_site_id (INT)
        $stmt = $pdo->prepare("
            SELECT s.*, u.*, p.*,
                   up.role as user_role,
                   ps.id as pool_site_id
            FROM user_sessions s
            JOIN users u ON s.user_id = u.user_id
            JOIN projects p ON s.project_id = p.project_id
            LEFT JOIN user_projects up ON u.user_id = up.user_id AND p.project_id = up.project_id
            LEFT JOIN pool_sites ps ON ps.project_id = p.project_id
            WHERE s.session_id = ?
            AND s.expires_at > NOW()
            AND u.is_active = 1
            AND p.is_active = 1
        ");

        $stmt->execute([$sessionId]);
        $session = $stmt->fetch();

        if (!$session) {
            if ($requireAuth) {
                self::unauthorized('Invalid or expired session');
            }
            return false;
        }

        // Update last activity
        $stmt = $pdo->prepare("UPDATE user_sessions SET last_activity = NOW() WHERE session_id = ?");
        $stmt->execute([$sessionId]);

        // Store in static properties for easy access
        self::$session = $session;
        self::$user = [
            'user_id' => $session['user_id'],
            'email' => $session['email'],
            'name' => $session['name'],
            'is_super_admin' => $session['is_super_admin'],
            'role' => $session['user_role'] ?: ($session['is_super_admin'] ? 'owner' : 'viewer')
        ];
        self::$project = [
            'project_id' => $session['project_id'],
            'project_name' => $session['project_name'],
            'pool_site_id' => $session['pool_site_id'] ? (int)$session['pool_site_id'] : null
        ];

        // Update PHP session
        $_SESSION[$sessionName . '_user_id'] = self::$user['user_id'];
        $_SESSION[$sessionName . '_project_id'] = self::$project['project_id'];
        $_SESSION[$sessionName . '_pool_site_id'] = self::$project['pool_site_id'];
        $_SESSION[$sessionName . '_user_role'] = self::$user['role'];

        return [
            'user' => self::$user,
            'project' => self::$project
        ];
    }

    /**
     * Check if user has specific role
     */
    public static function hasRole($requiredRole) {
        if (!self::$user) {
            return false;
        }

        $roleHierarchy = [
            'viewer' => 1,
            'operator' => 2,
            'admin' => 3,
            'owner' => 4
        ];

        $userLevel = $roleHierarchy[self::$user['role']] ?? 0;
        $requiredLevel = $roleHierarchy[$requiredRole] ?? 999;

        return $userLevel >= $requiredLevel;
    }

    /**
     * Get current user
     */
    public static function getUser() {
        return self::$user;
    }

    /**
     * Get current project
     */
    public static function getProject() {
        return self::$project;
    }

    /**
     * Get pool site ID for current project (integer)
     * Note: getSiteId() removed - use getPoolSiteId() instead
     */
    public static function getPoolSiteId() {
        return self::$project['pool_site_id'] ?? null;
    }

    /**
     * Log an audit event
     */
    public static function audit($action, $entityType = null, $entityId = null, $oldValues = null, $newValues = null) {
        if (!self::$user || !self::$pdo) {
            return;
        }

        try {
            $stmt = self::$pdo->prepare("
                INSERT INTO audit_log (user_id, project_id, action, entity_type, entity_id, old_values, new_values, ip_address)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            ");

            $stmt->execute([
                self::$user['user_id'],
                self::$project['project_id'],
                $action,
                $entityType,
                $entityId,
                $oldValues ? json_encode($oldValues) : null,
                $newValues ? json_encode($newValues) : null,
                $_SERVER['REMOTE_ADDR'] ?? null
            ]);
        } catch (Exception $e) {
            error_log('Audit log error: ' . $e->getMessage());
        }
    }

    /**
     * Logout current session
     */
    public static function logout() {
        if (self::$session) {
            $pdo = self::initDB();
            $stmt = $pdo->prepare("DELETE FROM user_sessions WHERE session_id = ?");
            $stmt->execute([self::$session['session_id']]);

            self::audit('logout');
        }

        session_destroy();
        self::$user = null;
        self::$project = null;
        self::$session = null;
    }

    /**
     * Send 401 unauthorized response
     */
    private static function unauthorized($message = 'Unauthorized') {
        http_response_code(401);
        header('Content-Type: application/json');
        echo json_encode(['error' => $message]);
        exit;
    }
}
